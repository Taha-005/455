{% extends "base.html" %}

{% block extra_css %}
<style>
    .hero {
        position: relative;
        overflow: hidden;
        text-align: center;
        padding: 4.5rem 2rem;
        border-radius: 18px;
        margin-bottom: 3rem;
        background: linear-gradient(135deg, rgba(244, 114, 182, 0.15), rgba(255, 255, 255, 0.9));
        border: 1px solid var(--border);
        box-shadow: var(--glow);
    }

    .hero h1 {
        font-size: 3.2rem;
        margin-bottom: 1rem;
        color: var(--primary-dark);
        letter-spacing: 0.5px;
    }

    .hero p {
        font-size: 1.3rem;
        color: var(--text-muted);
        max-width: 820px;
        margin: 0 auto;
    }

    .hero .hero-toolkit {
        margin-top: 0.4rem;
        color: #f472b6;
        font-weight: 800;
        font-size: 1.1rem;
    }

    body.dark .hero .hero-toolkit {
        color: #9ec5ff;
    }

    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .clickable-card {
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s, border 0.3s;
        border: 1px solid transparent;
    }

    .clickable-card h3 {
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
        font-weight: 800;
    }

    .clickable-card p {
        color: var(--text-muted);
    }

    .special-card {
        background: linear-gradient(135deg, rgba(244, 114, 182, 0.2), rgba(255, 255, 255, 0.95));
        border: 1px solid rgba(244, 114, 182, 0.4);
    }

    .special-card h3 {
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }

    .special-card p {
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    .special-card .btn {
        padding: 0.875rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-block;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        text-decoration: none;
        box-shadow: 0 10px 20px rgba(244, 114, 182, 0.28);
    }

    .special-card .btn:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 12px 26px rgba(236, 72, 153, 0.35);
    }

    .why-section {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(244, 114, 182, 0.12));
        border: 1px solid var(--border);
    }

    .why-section h2 {
        color: var(--primary-dark);
    }

    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        margin-top: 1.5rem;
    }

    .features-grid h4 {
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
        font-weight: 800;
    }

    .features-grid p {
        color: var(--text-muted);
    }

    /* CHATBOT SECTION WITH ROBOT ON BORDER */
    .chatbot-card {
        margin-bottom: 3rem;
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        position: relative;
        margin-top: 100px;
        overflow: visible;
    }

    .chatbot-card h3 {
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
        font-size: 1.7rem;
    }

    .chatbot-description {
        color: var(--text-muted);
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .chat-messages {
        height: 260px;
        padding: 0.9rem;
        margin-bottom: 0.9rem;
        background: rgba(255,255,255,0.85);
        border-radius: 10px;
        overflow-y: auto;
        border: 1px solid var(--border);
        font-size: 0.95rem;
        white-space: pre-line;
        position: relative;
    }

    body.dark .chat-messages {
        background: rgba(15,23,42,0.9);
    }

    .chat-message {
        margin-bottom: 0.6rem;
        line-height: 1.45;
    }

    .chat-message.user {
        text-align: right;
        font-weight: 500;
    }

    .chat-message.bot {
        text-align: left;
        color: var(--text);
    }

    .chat-input-row {
        display: flex;
        gap: 0.6rem;
        align-items: center;
        margin-top: 0.25rem;
    }

    .chat-input-row input {
        flex: 1;
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        border: 2px solid var(--border);
        font-size: 0.95rem;
        background: rgba(255,255,255,0.95);
        color: #000;
    }

    .chat-input-row input:focus {
        outline: none;
        border-color: var(--primary);
        background: #fff;
    }

    .chat-input-row button {
        padding: 0.7rem 1.3rem;
        border-radius: 10px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.25s ease;
    }

    .chat-input-row button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(37,99,235,0.35);
    }

    /* CUTE ROBOT - SITS ON BORDER WITH LEGS DANGLING */
    .robot-container {
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 100px;
        z-index: 30;
    }

    .robot-greeting {
        position: absolute;
        top: 5px;
        left: -140px;
        background: white;
        color: var(--primary);
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(155, 93, 229, 0.3);
        animation: fadeInGreeting 1s ease-in-out;
        border: 2px solid var(--primary);
    }

    body.dark .robot-greeting {
        background: rgba(30, 41, 59, 0.95);
        color: #60a5fa;
        border-color: #60a5fa;
        box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
    }

    /* Cloud-like speech bubble */
    .robot-greeting::before {
        content: '';
        position: absolute;
        right: -12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 12px solid white;
    }

    body.dark .robot-greeting::before {
        border-left-color: rgba(30, 41, 59, 0.95);
    }

    /* Small clouds for decoration */
    .robot-greeting::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
    }

    body.dark .robot-greeting::after {
        background: rgba(30, 41, 59, 0.95);
    }

    /* Robot Head */
    .robot-head {
        width: 50px;
        height: 45px;
        background: linear-gradient(135deg, #9b5de5, #60a5fa);
        border-radius: 12px;
        position: relative;
        margin: 0 auto;
        box-shadow: 0 4px 15px rgba(155, 93, 229, 0.4);
    }

    body.dark .robot-head {
        background: linear-gradient(135deg, #BA55D3, #00BFFF);
        box-shadow: 0 4px 20px rgba(186, 85, 211, 0.6), 0 0 30px rgba(0, 191, 255, 0.4);
    }

    /* Antenna */
    .robot-antenna {
        width: 3px;
        height: 12px;
        background: white;
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 3px;
    }

    .robot-antenna::after {
        content: '';
        width: 8px;
        height: 8px;
        background: #FFD700;
        border-radius: 50%;
        position: absolute;
        top: -8px;
        left: -2.5px;
        animation: antennaPulse 1.5s infinite;
        box-shadow: 0 0 10px #FFD700;
    }

    /* Eyes */
    .robot-eye {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 15px;
        animation: robotBlink 4s infinite;
    }

    .robot-eye.left { left: 10px; }
    .robot-eye.right { right: 10px; }

    .robot-pupil {
        width: 5px;
        height: 5px;
        background: #333;
        border-radius: 50%;
        position: absolute;
        top: 2.5px;
        left: 2.5px;
    }

    /* Mouth */
    .robot-mouth {
        width: 18px;
        height: 8px;
        border: 2px solid white;
        border-top: none;
        border-radius: 0 0 18px 18px;
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        animation: robotSmile 2s infinite ease-in-out;
    }

    /* Body */
    .robot-body {
        width: 45px;
        height: 35px;
        background: linear-gradient(135deg, #7c3aed, #3b82f6);
        border-radius: 8px;
        margin: 3px auto 0;
        position: relative;
        box-shadow: 0 3px 10px rgba(124, 58, 237, 0.3);
    }

    body.dark .robot-body {
        background: linear-gradient(135deg, #9b5de5, #60a5fa);
        box-shadow: 0 3px 15px rgba(155, 93, 229, 0.5), 0 0 20px rgba(96, 165, 250, 0.3);
    }

    /* Body Panel */
    .robot-panel {
        width: 30px;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .robot-light {
        width: 6px;
        height: 6px;
        background: #00FF7F;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: lightBlink 1s infinite;
        box-shadow: 0 0 8px #00FF7F;
    }

    /* Arms */
    .robot-arm {
        width: 8px;
        height: 25px;
        background: linear-gradient(180deg, #7c3aed, #3b82f6);
        border-radius: 5px;
        position: absolute;
        top: 48px;
    }

    body.dark .robot-arm {
        background: linear-gradient(180deg, #9b5de5, #60a5fa);
        box-shadow: 0 0 10px rgba(155, 93, 229, 0.4);
    }

    .robot-arm.left {
        left: 10px;
    }

    .robot-arm.right {
        right: 10px;
        animation: armWave 2s infinite ease-in-out;
        transform-origin: top center;
    }

    .robot-hand {
        width: 10px;
        height: 8px;
        background: #9b5de5;
        border-radius: 50%;
        position: absolute;
        bottom: -6px;
        left: -1px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    body.dark .robot-hand {
        background: #BA55D3;
        box-shadow: 0 2px 8px rgba(186, 85, 211, 0.4);
    }

    /* Legs - Dangling inside the box */
    .robot-legs {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 2px;
    }

    .robot-leg {
        width: 10px;
        height: 30px;
        background: linear-gradient(180deg, #7c3aed, #3b82f6);
        border-radius: 5px;
        position: relative;
        animation: legDangle 3s infinite ease-in-out;
    }

    .robot-leg.left {
        animation-delay: 0s;
    }

    .robot-leg.right {
        animation-delay: 0.5s;
    }

    body.dark .robot-leg {
        background: linear-gradient(180deg, #9b5de5, #60a5fa);
        box-shadow: 0 0 10px rgba(155, 93, 229, 0.4);
    }

    .robot-foot {
        width: 14px;
        height: 6px;
        background: #3b82f6;
        border-radius: 3px;
        position: absolute;
        bottom: -4px;
        left: -2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    body.dark .robot-foot {
        background: #60a5fa;
        box-shadow: 0 2px 8px rgba(96, 165, 250, 0.4);
    }

    @keyframes legDangle {
        0%, 100% { transform: rotate(5deg); }
        50% { transform: rotate(-5deg); }
    }

    /* Animations */
    @keyframes fadeInGreeting {
        0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        100% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes robotBlink {
        0%, 48%, 52%, 100% { transform: scaleY(1); }
        50% { transform: scaleY(0.1); }
    }

    @keyframes robotSmile {
        0%, 100% { height: 8px; }
        50% { height: 10px; }
    }

    @keyframes antennaPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.4); opacity: 0.7; }
    }

    @keyframes lightBlink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    @keyframes armWave {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-30deg); }
        50% { transform: rotate(-10deg); }
        75% { transform: rotate(-30deg); }
    }

    /* Dark mode refinements */
    body.dark .hero {
        background: linear-gradient(135deg, rgba(44, 58, 86, 0.35), rgba(16, 22, 33, 0.9));
        border-color: var(--border);
    }

    body.dark .special-card {
        background: linear-gradient(135deg, rgba(22, 30, 45, 0.9), rgba(18, 26, 40, 0.96));
        border-color: rgba(126, 172, 255, 0.35);
    }
</style>
{% endblock %}

{% block content %}
<div class="hero">
    <h1>Welcome to Numerography</h1>
    <p class="hero-toolkit">Your powerful toolkit for exploring number theory, cryptography, and advanced mathematical computations.</p>
</div>

<!-- FEATURE GRID -->
<div class="grid-container">
    <div class="card clickable-card" onclick="location.href='{{ url_for('factorization') }}'">
        <h3>Prime Factorization</h3>
        <p>Decompose any number into its prime factors with exponents. Essential for understanding number structure.</p>
    </div>

    <div class="card clickable-card" onclick="location.href='{{ url_for('euler_phi') }}'">
        <h3>Euler's Totient φ(n)</h3>
        <p>Calculate φ(n) – the count of numbers coprime to n. Critical for RSA encryption.</p>
    </div>

    <div class="card clickable-card" onclick="location.href='{{ url_for('primality_test') }}'">
        <h3>Primality Testing</h3>
        <p>Miller-Rabin probabilistic test to determine if large numbers are prime or composite.</p>
    </div>

    <div class="card clickable-card" onclick="location.href='{{ url_for('modular_exponentiation') }}'">
        <h3>Modular Exponentiation</h3>
        <p>Efficiently compute large powers with modular arithmetic. Foundation of modern cryptography.</p>
    </div>

    <div class="card clickable-card" onclick="location.href='{{ url_for('chinese_remainder') }}'">
        <h3>Chinese Remainder Theorem</h3>
        <p>Solve systems of congruences or extract remainders from numbers efficiently.</p>
    </div>

    <div class="card clickable-card" onclick="location.href='{{ url_for('gcd_lcm') }}'">
        <h3>GCD & LCM</h3>
        <p>Find the greatest common divisor and least common multiple of two numbers.</p>
    </div>

    {% if not current_user.is_authenticated %}
    <div class="card special-card">
        <h3>Create Account</h3>
        <p>Register to save your calculation history and access advanced features.</p>
        <a href="{{ url_for('register') }}" class="btn">Get Started</a>
    </div>
    {% endif %}
</div>

<!-- CHATBOT SECTION WITH ROBOT ON TOP -->
<div class="card chatbot-card">
    <!-- Cute Robot Sitting on Top -->
    <div class="robot-container">
        <div class="robot-greeting" id="robotGreeting">Hey There!</div>
        <div class="robot-head">
            <div class="robot-antenna"></div>
            <div class="robot-eye left">
                <div class="robot-pupil"></div>
            </div>
            <div class="robot-eye right">
                <div class="robot-pupil"></div>
            </div>
            <div class="robot-mouth"></div>
        </div>
        <div class="robot-body">
            <div class="robot-panel">
                <div class="robot-light"></div>
            </div>
        </div>
        <div class="robot-arm left">
            <div class="robot-hand"></div>
        </div>
        <div class="robot-arm right">
            <div class="robot-hand"></div>
        </div>
        <div class="robot-legs">
            <div class="robot-leg left">
                <div class="robot-foot"></div>
            </div>
            <div class="robot-leg right">
                <div class="robot-foot"></div>
            </div>
        </div>
    </div>

    <h3>Number Theory Tutor</h3>
    <p class="chatbot-description">
        Ask me how the app computes prime factorizations, φ(n), GCD/LCM, CRT, modular exponentiation,
        or primality tests. I'll walk you through the steps.
    </p>

    <div id="chatMessages" class="chat-messages">
        <div class="chat-message bot">
Hi! I'm the Numerography tutor.
You can ask things like:
• "How do you compute φ(60)?"
• "Explain how you find the GCD."
• "How does the Chinese Remainder Theorem work here?"
        </div>
    </div>

    <div class="chat-input-row">
        <input
            type="text"
            id="chatInput"
            placeholder="Type a question about number theory..."
        >
        <button type="button" id="chatSendBtn">Send</button>
    </div>
</div>

<!-- WHY SECTION -->
<div class="card why-section">
    <h2>Why Numerography?</h2>
    <div class="features-grid">
        <div>
            <h4>Lightning Fast</h4>
            <p>Optimized algorithms handle massive numbers efficiently.</p>
        </div>
        <div>
            <h4>Educational</h4>
            <p>Learn number theory through hands-on exploration.</p>
        </div>
        <div>
            <h4>History Tracking</h4>
            <p>Save and review all your calculations.</p>
        </div>
        <div>
            <h4>Secure</h4>
            <p>User authentication with encrypted passwords.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Update robot greeting with username
    {% if current_user.is_authenticated %}
        const username = "{{ current_user.username }}";
        const greeting = document.getElementById('robotGreeting');
        if (greeting && username) {
            greeting.textContent = `Hey There ${username}!`;
        }
    {% endif %}

    document.querySelectorAll('.clickable-card').forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-5px)';
            card.style.boxShadow = '0 10px 18px rgba(244, 114, 182, 0.2)';
            card.style.borderColor = 'rgba(244, 114, 182, 0.35)';
        });
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0)';
            card.style.boxShadow = 'var(--glow)';
            card.style.borderColor = 'transparent';
        });
    });

    // Chatbot functionality
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatMessages = document.getElementById('chatMessages');

    function appendMessage(text, sender) {
        if (!chatMessages) return;
        const div = document.createElement('div');
        div.classList.add('chat-message', sender);
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendChatMessage() {
        if (!chatInput) return;
        const text = chatInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user');
        chatInput.value = '';

        appendMessage('Thinking...', 'bot');

        try {
            const response = await fetch('/api/chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();

            const last = chatMessages.lastElementChild;
            if (last && last.classList.contains('bot') && last.textContent === 'Thinking...') {
                chatMessages.removeChild(last);
            }

            if (data.success) {
                appendMessage(data.reply, 'bot');
            } else {
                appendMessage(data.reply || 'Something went wrong on the server.', 'bot');
            }
        } catch (err) {
            appendMessage('Error talking to the server: ' + err.message, 'bot');
        }
    }

    if (chatSendBtn && chatInput) {
        chatSendBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }
</script>
{% endblock %}